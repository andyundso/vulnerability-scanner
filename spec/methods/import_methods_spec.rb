require 'rails_helper'
require Rails.root.join('lib', 'methods', 'import_methods')

RSpec.describe ImportMethods do

  let(:url) { 'https://nvd.nist.gov/feeds/xml/cve/nvdcve-2.0-Modified.xml.zip' }
  let(:destination) { Rails.root.join('tmp').to_s + '/tmp.zip' }

  describe :directory_to_save do

    it 'should return a file path with todays date and time' do
      time_now = Time.now
      estimated_file_path = Rails.root.join('files', 'xml_imports', time_now.strftime('%Y%m%d%H%M'))
      allow(Time).to receive(:now) { time_now }
      expect(ImportMethods.directory_to_save).to eq(estimated_file_path)
    end
  end

  describe :file_name do

    it 'should return a name with .zip extension' do
      expect(ImportMethods.file_name(url, '.zip')).to eq('nvdcve-2.0-Modified.zip')
    end
  end

  describe :download_file do

    it 'should download a file and copy it to a specific destination' do
      ImportMethods.download_file(url, destination)
      expect(File.exists? destination).to be_truthy
    end

    it 'should cleanup after the file got created' do
      FileUtils.rm(destination)
      expect(File.exists? destination).to be_falsey
    end
  end

end